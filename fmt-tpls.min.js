"use strict";angular.module("fmt",["fmt.player","fmt.playlist"]).config(["$sceDelegateProvider",function(a){a.resourceUrlWhitelist(["**"])}]),angular.module("fmt.components.filters.duration",[]).filter("duration",function(){return function(a){if(0>a)return"âˆž";var b=function(a){return(a>9?"":"0")+a};a=a||0;var c=Math.floor(a/3600);a-=3600*c;var d=Math.floor(a/60),e=Math.round(a-60*d),f=c>0?c+":":"";return f+=(d>0?b(d):"00")+":",f+=b(e)}}),angular.module("fmt.components.filters.parse",[]).filter("parse",function(){var a=function(a){var b=+a;return b.toString()===a};return function(b){return b&&(/^true$/i.test(b)?b=!0:/^false$/i.test(b)?b=!1:a(b)?b=parseFloat(b):/^{".+"}?/.test(b)&&(b=angular.fromJson(b))),b}}),angular.module("fmt.components.services.url",[]).service("Url",function(){var a=function(){for(var a={},c=[],d=arguments&&arguments[0]&&angular.isArray(arguments[0])?arguments[0]:arguments,e=0;e<d.length;e++){var f=d[e];angular.isObject(f)?a=angular.extend(a,f):(angular.isString(f)||(f=String(f)),c.push(f.replace(/^\/(?=[^\/])|\/$/g,"")))}var g=c.join("/");return a&&a.length&&(g+=g.indexOf("?")>0?"&":"?",g+=b(a)),g},b=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&(a[c]===!1||a[c])&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},c=function(a,b){var c=new RegExp("[?|&]"+a+"=([^&;]+?)(&|#|;|$)");return decodeURIComponent((c.exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||b},d=function(a,b,c){var d=b+"="+c,e="?"+d;return a&&(e=a.replace(new RegExp("([?&])"+b+"[^&]*"),"$1"+d),e===a&&(e+="&"+d)),e};return{joinUrl:a,encodeQueryData:b,getURLParameter:c,addUrlParam:d}}),angular.module("fmt.components.services.widget-api",["fmt.components.services.url"]).service("WidgetApi",["$q","$http","$location","Url",function(a,b,c,d){var e=this,f=function(){var a=null;if(window.fmtBaseUrl){var b=window.fmtBaseUrl.match(/(.*\/\/media[0-9]*\.webtv.*)\/cust\/(.*)\/static/i);a=b&&3===b.length?b[1].replace(/media[0-9]*\./i,"api."+b[2]+"."):d.joinUrl(window.fmtBaseUrl.match(/.*\/\/[a-z0-9:\.]*\//i)[0],"api")}else window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host),a=d.joinUrl(window.location.origin,"api");return a};e.config={apiBaseUrl:f()};var g=function(){var a={api_key:e.config.apiKey,api_nonce:Math.floor(1e7+9e7*Math.random()),api_referrer:e.config.apiReferrer,api_timestamp:Math.round((new Date).getTime()/1e3)+e.config.timedelta},b=d.encodeQueryData(a)+"9n1IzQrHUwy1uWhaiuHY2w7qk4vK1FUO";return _.extend(a,{api_signature:CryptoJS.SHA1(b).toString()}),a},h=a.defer();h.resolve(!0);var i=h.promise,j=_.once(function(){return m("config",{r:(new Date).getTime()}).then(function(a){return e.config=angular.extend(e.config,{apiKey:a.key,version:a.version,timedelta:a.timestamp-Math.round((new Date).getTime()/1e3),apiReferrer:c.search().apiReferrer||window.top.location.host}),a})}),k=function(a){var c=Array.prototype.slice.call(arguments,1),f=e.config.version||"config"===c[0]?i:j();return f.then(function(){c.unshift(e.config.apiBaseUrl),"jsonp"===a&&c.push({callback:"JSON_CALLBACK"});var f=d.joinUrl.apply(this,c),h=/(^players|streams$|stats)/,i="cassidy"!==e.config.version&&h.test(f);return i&&(c.push(g()),f=d.joinUrl.apply(this,c)),b({method:a,url:f,withCredentials:!0})}).then(function(a){return a.data})},l=function(){return"withCredentials"in new XMLHttpRequest||"object"==typeof XDomainRequest},m=function(){var a=Array.prototype.slice.call(arguments);return a.unshift(l()?"get":"jsonp"),k.apply(this,a)};return{get:m}}]),angular.module("fmt.components.services.analytics",[]).constant("fmtAnalyticsConfig",{gaAccount:"UA-46378267-1",fmtEvents:["hit","inst","thru"],gaEvents:{hit:"Hit",inst:"Inst",thru:"Thru",pause:"Pause",play:"Play",seeked:"Seek",volumechange:"Volume"}}).service("Analytics",["$rootScope","$window","$location",function(a,b,c){var d=function(){b.GoogleAnalyticsObject="ga",b.ga=b.ga||function(){(b.ga.q=b.ga.q||[]).push(arguments)},b.ga.l=1*new Date;var a=document.createElement("script"),c=document.getElementsByTagName("script")[0];a.async=1,a.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(a,c)},e=function(a){var c=null;b.location.hostname.match(/localhost|([0-9]{1,3}\.){3}[0-9]{1,3}/i)&&(c={cookieDomain:"none"}),b.ga("create",a,c)},f=function(){a.$on("$viewContentLoaded",function(){(b.ga||angular.noop)("send","pageview",{page:c.path()})})},g=function(a,c,d,e){(b.ga||angular.noop)("send","event",a,c,d,e)},h=function(a,b){a&&(d(),e(a),b&&b.trackPagesEnabled&&f())};return{initialize:h,trackEvent:g}}]),angular.module("fmt.components.services.widget-analytics",["fmt.components.services.widget-api","fmt.components.services.analytics"]).service("WidgetAnalytics",["WidgetApi","Analytics","fmtAnalyticsConfig",function(a,b,c){var d,e,f,g,h=-1,i=-1,j=function(a){a=a||1;var b="function"==typeof d.currentTime?d.currentTime():d.currentTime,c="function"==typeof d.duration?d.duration():d.duration,e=b/c*100;return a*Math.floor(e/a)},k=function(){if(0>h)l("hit"),h=0;else if(!g){var a=j(5);if(a===h)return;a===h+5?(l("inst",a),h=a):a!==i&&(l("thru",a),i=a)}},l=function(d,g,h,i,j){if(g=g||0,h=h||e,i=i||f,j=j||3,h&&_.contains(c.fmtEvents,d)){g=("00"+g).slice(-3);var k="hit"!==d?d+"_p"+g:d;a.get("stats/video",k.toUpperCase(),{gateway_id:j||1,video_id:h.id})}if(c.gaAccount&&_.has(c.gaEvents,d)){var l=h?h.livestream?"Live":"VoD":"External",m=c.gaEvents[d],n=h?"["+h.id+"] "+(h.title||h.name):i;b.trackEvent(l,m,n,g)}},m=function(){c.gaAccount&&b.initialize(c.gaAccount)},n=function(a,b,c){d=a,e=b,f=c,g=b&&b.livestream,h=i=-1,a&&(a.on?a.on("timeupdate",k):a.addEventListener&&a.addEventListener("timeupdate",k))};return{initialize:m,startTracking:n,trackEvent:l}}]),angular.module("fmt.player",["fmt.components.filters.parse","fmt.components.services.widget-api","fmt.components.services.widget-analytics"]).constant("fmtPlayerConfig",{elementId:"fmt-player",src:null,content:"",autoplayEnabled:!1,playerHtml5:"videojs",playerFlash:"videojs",techOrder:"html5_flash",posterUrl:"",playerSwfBaseUrl:"",plugin_flumotioncdn:"${player_base_url}/FlumotionCDNPlugin.swf",flumotioncdn_namespace:"http://www.flumotion.com/plugins/flumotioncdn/1.0",flumotioncdn_hd:!0,flumotioncdn_high:!0,flumotioncdn_med:!0,flumotioncdn_low:!0,plugin_menudisplay:null,menudisplay_namespace:"http://www.flumotion.com/plugins/menudisplay/1.0",menudisplay_likeInfoVisible:!0,menudisplay_imageVisible:!0,menudisplay_autoHideEnabled:!0,menudisplay_autoHideTimeout:3,menudisplay_nameVisible:!0,menudisplay_descriptionVisible:!1,menudisplay_tooltipsEnabled:!0,menudisplay_shareButtonEnabled:!1,menudisplay_likeButtonEnabled:!1,menudisplay_embedButtonEnabled:!1,menudisplay_downloadButtonEnabled:!1,menudisplay_commentsButtonEnabled:!1,plugin_share:null,share_namespace:"http://www.flumotion.com/plugins/share/1.0",share_enabled:!0,plugin_embed:null,embed_namespace:"http://www.flumotion.com/plugins/embed/1.0",embed_enabled:!0,plugin_comments:null,comments_namespace:"http://www.flumotion.com/plugins/comments/1.0",comments_enabled:!0,plugin_captioning:null,captioning_namespace:"http://www.flumotion.com/plugins/captioning/1.0",captioning_enabled:!0,plugin_relatedcontent:null,relatedcontent_namespace:"http://www.flumotion.com/plugins/relatedcontent/1.0",relatedcontent_enabled:!0,plugin_branding:null,branding_namespace:"http://www.flumotion.com/plugins/branding/1.0",branding_uri:"http://www.flumotion.com/wp-content/uploads/header_logo3.png",branding_width:120,branding_height:80,branding_clickThroughURL:null,branding_verticalAlign:"top",branding_horizontalAlign:"right",branding_alpha:.8,playButtonOverlay:!0,bufferingOverlay:!0,scaleMode:"letterbox",posterScaleMode:"letterbox",controlBarMode:"docked",volumeBarVisible:!0,qualitiesVisible:!0,fullscreenVisible:!0,controlBarHotButtons:"",controlBarTooltipsEnabled:!1,skin:"flumotion_v3",primaryColor:"#000000",secondaryColor:"#ff0000",tertiaryColor:"#ff0000",backgroundColor:"#000000"}).controller("FmtPlayerController",["$rootScope","$scope","$filter","fmtPlayerConfig","WidgetAnalytics","WidgetApi",function(a,b,c,d,e,f){var g=this;this.setupConfiguration=function(){var a=_.defaults(_.pick(b,_.keys(d)),d);_.each(a,function(b,d){a[d]=c("parse")(b)}),a.autoPlay=a.autoplayEnabled,a.api_referrer=a.apiReferrer,a.playerId=a.playerId||a.player,a.campaignId=a.campaignId||a.campaign||a.explicitCampaignId,a.playerHtml5=/iPhone|iPod|iPad/i.test(navigator.userAgent)?"browser":a.playerHtml5,a.content&&a.src&&(a.srcExtraParams=a.src.substring(b.config.src.indexOf("?")+1)),b.config=a},this.initialize=function(){b.config.content&&e.initialize(b.config),g.loadContent()},this.loadContent=function(){b.config.content?(g.loadPod(b.config.content),g.loadStreams({id:b.config.content})):b.config.src&&g.loadSrc(b.config.src)},this.loadPod=function(a){f.get("pods",a,{extended:!0}).then(function(a){b.pod=a})},this.loadStreams=function(a){a.streams?b.streams=a.streams:f.get("pods",a.id,"streams").then(function(a){b.streams=a})},this.loadSrc=function(a){a&&(b.streams=[{url:a,mimetype:"video/"+c("extension")(a)}])},a.$on("fmtPodSelected",function(a,c){c&&(b.pod&&b.pod.id!==c.id&&(b.config.autoplayEnabled=!0),b.pod=c,g.loadStreams(c))}),b.$watch("config.src",g.loadSrc)}]).directive("fmtPlayer",["$parse","fmtPlayerConfig",function(a,b){var c=function(){var a=_.clone(b);return _.each(a,function(b,c){a[c]="@"}),a};return{templateUrl:"template/player/player.html",controller:"FmtPlayerController",scope:c(),link:function(a,b,c,d){d.setupConfiguration(),b.addClass(["fmt-w","player",a.config.elementId].join(" ")),d.initialize(),a.$watch("src+techOrder+playerHtml5",d.setupConfiguration)}}}]).directive("fmtPlayerBrowser",["WidgetAnalytics",function(a){return{templateUrl:"template/player/player-browser.html",require:"^fmtPlayer",replace:!0,scope:{streams:"=",config:"="},link:function(b,c){b.$watch("config.autoplayEnabled",function(a){a?c.attr("autoplay",a):c.removeAttr("autoplay")}),b.$watch("config.controlBarMode",function(a){"none"!==a?c.attr("controls",a):c.removeAttr("controls")}),a.startTracking(c[0],b.pod,b.streams[0].url)}}}]).controller("FmtPlayerVideojsController",["$rootScope","$scope","WidgetAnalytics","WidgetApi","Url",function(a,b,c,d,e){var f=function(a){var c="";_.each(a,function(a){c+="<source src="+a.url+" type="+a.mimetype+"></source>"});var d=$("."+b.config.elementId),e='<video id=ID class="video-js vjs-default-skin" width=WIDTH height=HEIGHT>STREAMS</video>';return e.replace("ID",b.config.elementId).replace("WIDTH",d.width()).replace("HEIGHT",d.height()).replace("STREAMS",c)},g=function(){var a={flashVars:{javascriptCallbackFunction:"onFlashCallbackFunction"}},c=b.config.playerSwfBaseUrl.replace(/^https:\/\//,"//"),f=e.joinUrl(c,"audio/current"),g="strobe"===b.config.playerFlash?"PlayerStrobe.swf":"StrobeMediaPlayback.swf";if(a.swf=e.joinUrl(f,g),b.config.playerId&&b.config.content){var h=e.joinUrl(d.getBaseUrl(),"player.xml",{pod:b.config.content,player:b.config.playerId,campaignId:b.config.campaignId,srcExtraParams:b.config.srcExtraParams});a.flashVars.configuration=encodeURIComponent(h)}else{var i=_.defaults({base_path:f+"/",podId:b.config.content},b.config);i=_.omit(i,"configuration");for(var j in i)!i.hasOwnProperty(j)||void 0!==i[j]&&null!==i[j]||delete i[j];a.flashVars=_.defaults(a.flashVars,i)}if(b.config.content&&"strobe"===b.config.playerFlash&&"cassidy"!==b.config.apiVersion){var k=e.joinUrl(d.getBaseUrl(),"pods",b.config.content,"streams.f4m",d.sign());a.flashVars.srcManifest=encodeURIComponent(k)}return a},h=function(a){var c={controls:!1,preload:"auto",poster:(b.pod?b.pod.video_image_url:null)||b.config.posterUrl,autoplay:b.config.autoplayEnabled,techOrder:a,flash:{params:{allowFullScreen:!0}}};return b.config.playerFlash&&"videojs"!==b.config.playerFlash&&_.extend(c.flash,g()),c},i=function(){if(b.playerVideoJs){var a=$("."+b.config.elementId);b.playerVideoJs.width(a.width()).height(a.height())}},j=function(){b.changingQuality&&(b.playerVideoJs.currentTime(b.changingQuality.time),b.changingQuality=null)},k=function(){},l=function(){b.playerVideoJs=this,c.startTracking(this,b.pod,b.streams[0].url),this.on("loadeddata",j),this.on("durationchange",k),this.on("ended",function(){a.$emit("fmtPodFinished")}),b.changingQuality&&!b.changingQuality.paused&&this.play(),a.$emit("fmtPodReady",{pod:b.pod,streams:b.streams,currentStreamUrl:this.currentSrc()}),"none"===b.config.controlBarMode||"Html5"!==this.techName&&"videojs"!==b.config.playerFlash||this.controls(!0)},m=function(a){var b=!1,c=document.createElement("video");return c.canPlayType&&(b=_.some(a,function(a){return c.canPlayType(a)})),b};this.initialize=function(){if(b.streams&&$(".player-wrapper")){if(!angular.element(document.querySelector("#cssFmtPlayerVideojs")).length){var a='<link id="cssFmtPlayerVideojs" href="//vjs.zencdn.net/4.3/video-js.css" rel="stylesheet">';angular.element(document.querySelector("head")).append(a)}b.playerVideoJs=null;var c=f(b.streams);$("."+b.config.elementId+" .player-wrapper").html(c),"strobe"===b.config.playerFlash&&(videojs.Flash.bd=_.extend(videojs.Flash.bd,{"audio/flv":"FLV","audio/x-flv":"FLV","audio/mp3":"FLV","audio/m4a":"FLV","audio/mpeg":"FLV"}));var d=b.config.techOrder.split("_");m(_.pluck(b.streams,"mimetype"))||(d=_.without(d,"html5"));var e=h(d);b.videoTag=$("#"+b.config.elementId)[0],videojs(b.videoTag,e).ready(l)}},$(window).resize(i),a.$on("fmtPodQualitySelected",function(a,c){b.changingQuality={time:b.playerVideoJs.currentTime(),paused:b.playerVideoJs.paused()},b.streams=[c.stream],b.playerVideoJs.controls(!1)}),b.onFlashCallbackFunction=function(d,e,f){"onJavaScriptBridgeCreated"===e?videojs.Flash.onReady(d):"complete"===e?a.$emit("fmtPodFinished",b.pod):"metadataChanged"===e&&a.$emit("fmtPodMetadataChanged",f.value),c.trackEvent(e,f?f.value:null,b.pod,b.streams[0].url,f.gatewayId)}}]).directive("fmtPlayerVideojs",function(){return{template:'<div><div class="player-wrapper"></div>',controller:"FmtPlayerVideojsController",replace:!0,scope:{streams:"=",config:"="},link:function(a,b,c,d){var e=!1;a.$watch("streams",function(){a.streams&&a.config.techOrder&&(e?d.initialize():(e=!0,$.getScript("http://vjs.zencdn.net/4.3/video.js",d.initialize)))})}}}),window.onFlashCallbackFunction=function(a,b,c){var d=angular.element("#"+a).scope();d.onFlashCallbackFunction(a,b,c),d.$apply()},angular.module("fmt.playlist",["fmt.components.filters.duration","fmt.components.filters.parse","fmt.components.services.widget-api"]).constant("fmtPlaylistConfig",{elementId:"fmt-playlist",content:null,cssUrl:null,nameVisible:!0,thumbVisible:!0,durationVisible:!0,likesVisible:!0,dateVisible:!1,columns:1,currentItemId:null,autoAdvanceEnabled:!1}).controller("FmtPlaylistController",["$window","$document","$rootScope","$scope","$http","$timeout","WidgetApi",function(a,b,c,d,e,f,g){var h=this;this.selectItemById=function(a){if(d.config.currentItemId=a,d.items&&d.items.length&&"none"!==a){var b=_.findWhere(d.items,{id:a+""});d.selectItem(b||d.items[0])}},this.onContentLoaded=function(a){d.items=a.data||a.items||a,h.selectItemById(d.config.currentItemId)},this.initialize=function(){angular.isNumber(d.config.content)?g.get("smartlists",d.config.content,"items").then(h.onContentLoaded):d.config.content&&e.get(d.config.content).then(h.onContentLoaded)},d.selectItem=function(a){c.$emit("fmtPodSelected",a)},c.$on("fmtPodSelected",function(a,b){f(function(){d.currentItem=b})}),c.$on("fmtPodFinished",function(){if(d.config.autoAdvanceEnabled){var a=d.items.indexOf(d.currentItem)+1;a<d.items.length&&d.selectItem(d.items[a])}})}]).directive("fmtPlaylist",["$filter","fmtPlaylistConfig",function(a,b){var c=function(){var a=angular.copy(b);return angular.forEach(a,function(b,c){a[c]="@"}),a};return{templateUrl:"template/playlist/playlist.html",controller:"FmtPlaylistController",scope:c(),link:function(c,d,e,f){var g=function(){var d=_.defaults(_.pick(c,_.keys(b)),b);_.each(d,function(b,c){d[c]=a("parse")(b)}),c.config=d};g(),d.addClass(["fmt","fmt-playlist",c.config.elementId].join(" ")),f.initialize();var h=_.without(_.keys(b),"currentItemId").join("+");c.$watch(h,g),c.$watch("currentItemId",f.selectItemById)}}}]).directive("fmtPlaylistItem",function(){return{templateUrl:"template/playlist/playlist-item.html",require:"^fmtPlaylist"}});
angular.module("fmt").run(["$templateCache",function(a){"use strict";a.put("template/player/player-browser.html",'<video ng-src="{{streams[0].url}}" width="100%" height="100%" style="width: 100%; height: 100%;">\n  Your browser does not support the video tag.\n</video>'),a.put("template/player/player-videojs.html",'<div>\n  <div class="player-wrapper"></div>\n  <div ng-if="config.podThumbsUrl" class="visual-seeking tooltip top in">\n    <div class="tooltip-arrow"></div>\n    <div class="tooltip-inner">\n      <span class="img"></span><span class="time"></span>\n    </div>\n  </div>\n</div>'),a.put("template/player/player.html",'<!-- VideoJS -->\n<div ng-if="config.playerHtml5===\'videojs\'" fmt-player-videojs streams="streams" config="config"></div>\n\n<!-- Browser -->\n<div ng-if="config.playerHtml5===\'browser\'" fmt-player-browser streams="streams" config="config"></div>'),a.put("template/playlist/playlist-item.html",'<div class="media">\n  <div class="pull-left thumb-wrap" ng-if="config.thumbVisible" style="position: relative; width: 143px;">\n    <img ng-src="{{item.thumbnail_url}}" class="pull-left" style="width: 100%;">\n      <span class="label label-default label-overlay"\n            ng-if="config.durationVisible"\n            style="position: absolute; bottom: 2px; right: 2px;">\n        {{item.livestream?\'live\':(item.duration|duration)}}\n      </span>\n  </div>\n  <div class="media-body">\n    <h4 class="list-group-item-heading" ng-if="config.nameVisible">{{item.name || item.title}}</h4>\n    <p class="list-group-item-text" ng-if="config.likesVisible">\n      {{item.total_rates}} likes\n    </p>\n    <p class="list-group-item-text" ng-if="config.dateVisible">\n'+"      {{(item.creationDate || item.created_on).replace(' ', 'T') | date:'mediumDate'}}\n    </p>\n  </div>\n</div>"),a.put("template/playlist/playlist.html",'<div class="list-group container-fluid" style="padding: 0; margin-bottom: 0;">\n    <a ng-repeat="item in items"\n       fmt-playlist-item\n       item="item"\n       fields="config.itemFields"\n       ng-href=""\n       ng-click="selectItem(item)"\n       class="list-group-item"\n       ng-class="{active: currentItem && item.id === currentItem.id}">\n    </a>\n</div>')}]);